import React, { useState, useEffect } from 'react';
import { View, Text, StyleSheet, ScrollView, Image, TouchableOpacity, Share, Alert, ActivityIndicator } from 'react-native';
import { useLocalSearchParams, useRouter } from 'expo-router';
import { Audio } from 'expo-av';
import { Volume2, Share2, CornerUpRight, Info, AlertTriangle, ShieldCheck, Download, Headphones, Check } from 'lucide-react-native';
import ConfidenceBar from '../components/ConfidenceBar';
import PesticideCard from '../components/PesticideCard';
import CostCalculator from '../components/CostCalculator';
import ProgressionIndicator from '../components/ProgressionIndicator';
import api, { API_URL } from '../services/api';
import { useLanguage } from '../context/LanguageContext';
import { useAppTheme } from '../context/ThemeContext';
import { Colors } from '../constants/theme';

export default function ResultsScreen() {
    const { data } = useLocalSearchParams();
    const [result, setResult] = useState<any>(null);
    const [sound, setSound] = useState<Audio.Sound | null>(null);
    const [isPlaying, setIsPlaying] = useState(false);
    const router = useRouter();
    const { t, language } = useLanguage();
    const { isDarkMode, colorScheme } = useAppTheme();
    const themeParams = Colors[colorScheme];

    useEffect(() => {
        if (data) {
            setResult(JSON.parse(data as string));
        }

        return () => {
            if (sound) {
                sound.unloadAsync();
            }
        };
    }, [data]);

    // This function plays the "AI Doctor's" voice explanation
    const playVoice = async () => {
        if (!result?.voice_file) {
            Alert.alert(t('error'), 'Voice file not generated by the server. Google TTS API might have rate limited the generation.');
            return;
        }

        try {
            if (sound) {
                if (isPlaying) {
                    await sound.pauseAsync();
                    setIsPlaying(false);
                } else {
                    await sound.playAsync();
                    setIsPlaying(true);
                }
                return;
            }

            setIsPlaying(true);
            const baseUrl = API_URL.replace('/api', '').replace(/\/$/, '');
            const audioUrl = `${baseUrl}${result.voice_file}`;
            console.log('Playing audio from:', audioUrl);

            const { sound: newSound } = await Audio.Sound.createAsync(
                { uri: audioUrl },
                { shouldPlay: true }
            );
            setSound(newSound);

            newSound.setOnPlaybackStatusUpdate((status: any) => {
                if (status.didJustFinish) {
                    setIsPlaying(false);
                }
            });
        } catch (error) {
            console.error('Error playing sound detailed', error);
            const errorMsg = error instanceof Error ? error.message : String(error);
            Alert.alert(t('error'), `${t('failedVoice')}: ${errorMsg}`);
            setIsPlaying(false);
        }
    };

    const [isSharing, setIsSharing] = useState(false);

    const handleShare = async () => {
        if (!result) return;

        const { prediction, disease_info, pesticide_recommendations } = result;
        const labels = result.ui_translations || {};

        let displayDisease = prediction.disease_local || prediction.disease.replace(/___/g, ': ').replace(/_/g, ' ');
        if (prediction.disease === 'Healthy' && !prediction.disease_local) {
            displayDisease = t('healthy');
        }

        let displayStage = prediction.stage_local || prediction.stage;
        if (prediction.stage === 'Healthy Stage' && !prediction.stage_local) {
            displayStage = t('healthyStage');
        } else if (prediction.stage && !prediction.stage_local) {
            const stageKey = prediction.stage.toLowerCase().replace(' ', '_');
            displayStage = t(stageKey as any) || prediction.stage;
        }

        setIsSharing(true);
        try {
            // Prepare data for PDF
            const pdfData = {
                diagnosis_id: result.diagnosis_id || 'N/A',
                crop: labels[`crop_${prediction.crop.toLowerCase()}`] || t(`crop_${prediction.crop.toLowerCase()}` as any),
                disease: displayDisease,
                confidence: prediction.confidence,
                severity: prediction.severity_percent,
                stage: displayStage,
                description: disease_info.description || (prediction.disease === 'Healthy' ? t('diseaseDescription') : ''),
                symptoms: disease_info.symptoms || (prediction.disease === 'Healthy' ? t('symptomsHealthy') : ''),
                treatment_approach: pesticide_recommendations?.treatment_approach || 'N/A',
                pesticides: (pesticide_recommendations?.recommended_pesticides || []).map((p: any) => ({
                    name: p.name,
                    dosage: p.dosage,
                    frequency: p.frequency
                })),
                prevention_steps: disease_info.prevention_steps || (prediction.disease === 'Healthy' ? t('preventionHealthy') : ''),
                date: new Date().toLocaleDateString()
            };

            const { generateDiagnosisPDF } = await import('../services/PDFService');
            const pdfUri = await generateDiagnosisPDF(pdfData);

            if (pdfUri) {
                console.log('PDF success at:', pdfUri);
            }
        } catch (error) {
            console.error('Error sharing PDF', error);
        } finally {
            setIsSharing(false);
        }
    };

    if (!result) return <View style={styles.container} />;

    const { prediction, disease_info, pesticide_recommendations, weather_advice } = result;
    // We use the translations returned by the server. 
    // They are already tailored to the requested language.
    const labels = result.ui_translations || {};

    // Make the disease name look nice (remove underscores)
    let displayDisease = prediction.disease_local || prediction.disease.replace(/___/g, ': ').replace(/_/g, ' ');
    if (prediction.disease === 'Healthy' && !prediction.disease_local) {
        displayDisease = t('healthy');
    }

    let displayStage = prediction.stage_local || prediction.stage;
    if (prediction.stage === 'Healthy Stage' && !prediction.stage_local) {
        displayStage = t('healthyStage');
    } else if (prediction.stage && !prediction.stage_local) {
        // Try to translate the stage key (e.g., 'early', 'late')
        const stageKey = prediction.stage.toLowerCase().replace(' ', '_');
        displayStage = t(stageKey as any) || prediction.stage;
    }

    return (
        <ScrollView style={[styles.container, { backgroundColor: isDarkMode ? themeParams.background : '#f5f5f5' }]}>
            {/* Status Banner: Green for Good, Orange for Warning */}
            <View style={[styles.statusBanner, { backgroundColor: prediction.confidence > 80 ? (isDarkMode ? '#1e3b20' : '#e8f5e9') : (isDarkMode ? '#3e2723' : '#fff3e0') }]}>
                {prediction.confidence > 80 ? (
                    <ShieldCheck color="#2e7d32" size={24} />
                ) : (
                    <AlertTriangle color="#ef6c00" size={24} />
                )}
                <Text style={[styles.statusText, { color: prediction.confidence > 80 ? '#2e7d32' : '#ef6c00' }]}>
                    {prediction.disease === 'Healthy'
                        ? (labels.healthy_crop || t('healthyCrop'))
                        : (labels.potential_disease || t('potentialDisease'))}
                </Text>
            </View>

            {/* Core Diagnosis Info */}
            <View style={[styles.section, { backgroundColor: isDarkMode ? '#1e1e1e' : '#fff' }]}>
                <View style={styles.titleRow}>
                    <Text style={[styles.cropTitle, { color: isDarkMode ? '#aaa' : '#666' }]}>
                        {labels[`crop_${prediction.crop.toLowerCase()}`] || t(`crop_${prediction.crop.toLowerCase()}` as any)}
                    </Text>
                    <View style={[styles.stageBadge, { backgroundColor: isDarkMode ? '#333' : '#f0f0f0' }]}>
                        <Text style={[styles.stageText, { color: isDarkMode ? '#ccc' : '#444' }]}>{displayStage}</Text>
                    </View>
                </View>
                <Text style={[styles.diseaseName, { color: isDarkMode ? '#fff' : '#333' }]}>{displayDisease}</Text>

                <ConfidenceBar
                    confidence={prediction.confidence}
                    label={labels.confidence_score}
                />

                <View style={styles.statsRow}>
                    <View style={[styles.statBox, { backgroundColor: isDarkMode ? '#2c2c2c' : '#f9f9f9' }]}>
                        <Text style={[styles.statLabel, { color: isDarkMode ? '#888' : '#888' }]}>{labels.severity || t('severity')}</Text>
                        <Text style={[styles.statValue, { color: isDarkMode ? '#fff' : '#333' }]}>{prediction.severity_percent.toFixed(1)}%</Text>
                    </View>
                    <View style={[styles.statBox, { backgroundColor: isDarkMode ? '#2c2c2c' : '#f9f9f9' }]}>
                        <Text style={[styles.statLabel, { color: isDarkMode ? '#888' : '#888' }]}>{labels.diagnosis_id || t('diagnosisId')}</Text>
                        <Text style={[styles.statValue, { color: isDarkMode ? '#fff' : '#333' }]}>#{result.diagnosis_id || 'N/A'}</Text>
                    </View>
                </View>
            </View>

            {prediction.disease !== 'Healthy' && (
                <View style={{ paddingHorizontal: 20 }}>
                    <ProgressionIndicator
                        severity={prediction.severity_percent}
                        stage={displayStage}
                        labels={labels}
                    />
                </View>
            )}

            <View style={styles.actionButtons}>
                <TouchableOpacity style={styles.actionButton} onPress={playVoice}>
                    {isPlaying ? <Headphones size={20} color="#fff" /> : <Volume2 size={20} color="#fff" />}
                    <Text style={styles.actionButtonText}>
                        {isPlaying ? (labels.pause_explanation || t('pauseExplanation')) : (labels.voice_explanation || t('voiceExplanation'))}
                    </Text>
                </TouchableOpacity>
                <TouchableOpacity
                    style={[styles.actionButton, styles.secondaryButton, { backgroundColor: isDarkMode ? '#1e1e1e' : '#fff' }, isSharing && { opacity: 0.7 }]}
                    onPress={handleShare}
                    disabled={isSharing}
                >
                    {isSharing ? (
                        <ActivityIndicator size="small" color="#4caf50" />
                    ) : (
                        <>
                            <Download size={20} color="#4caf50" />
                            <Text style={[styles.actionButtonText, styles.secondaryButtonText]}>{labels.share_report || t('shareReport')}</Text>
                        </>
                    )}
                </TouchableOpacity>
            </View>

            {weather_advice && (
                <View style={[styles.weatherBox, { backgroundColor: isDarkMode ? '#1a2c3f' : '#e3f2fd' }]}>
                    <Info size={20} color={isDarkMode ? '#64b5f6' : '#1976d2'} />
                    <View style={styles.weatherContent}>
                        <Text style={[styles.weatherTitle, { color: isDarkMode ? '#64b5f6' : '#1976d2' }]}>{labels.weather_advice || t('weatherAdvice')}</Text>
                        <Text style={[styles.weatherText, { color: isDarkMode ? '#ccc' : '#444' }]}>{weather_advice}</Text>
                    </View>
                </View>
            )}

            <View style={[styles.section, { backgroundColor: isDarkMode ? '#1e1e1e' : '#fff' }]}>
                <Text style={[styles.sectionTitle, { color: isDarkMode ? '#fff' : '#333' }]}>{labels.disease_info || t('diseaseInfo')}</Text>
                <Text style={[styles.infoText, { color: isDarkMode ? '#ccc' : '#555' }]}>
                    {disease_info.description || (prediction.disease === 'Healthy' ? t('diseaseDescription') : '')}
                </Text>
                <Text style={[styles.subSubtitle, { color: isDarkMode ? '#ddd' : '#444' }]}>{labels.symptoms || t('symptoms')}:</Text>
                <Text style={[styles.infoText, { color: isDarkMode ? '#ccc' : '#555' }]}>
                    {disease_info.symptoms || (prediction.disease === 'Healthy' ? t('symptomsHealthy') : '')}
                </Text>
            </View>

            {prediction.disease !== 'Healthy' && pesticide_recommendations && (
                <>
                    <View style={[styles.section, { backgroundColor: isDarkMode ? '#1e1e1e' : '#fff' }]}>
                        <View style={styles.sectionHeader}>
                            <Text style={[styles.sectionTitle, { color: isDarkMode ? '#fff' : '#333' }]}>{labels.treatment_plan || t('treatmentPlan')}</Text>
                            <View style={[styles.urgencyBadge, { backgroundColor: (pesticide_recommendations?.urgency || 'medium') === 'high' ? (isDarkMode ? '#4a1515' : '#ffebee') : (isDarkMode ? '#1e3b20' : '#e8f5e9') }]}>
                                <Text style={[styles.urgencyText, { color: (pesticide_recommendations?.urgency || 'medium') === 'high' ? (isDarkMode ? '#ff8a80' : '#d32f2f') : (isDarkMode ? '#81c784' : '#2e7d32') }]}>
                                    {(pesticide_recommendations?.urgency || 'medium').toUpperCase()} {labels.urgency || t('urgency')}
                                </Text>
                            </View>
                        </View>

                        <Text style={[styles.approachText, { color: isDarkMode ? '#bbb' : '#555' }]}>{pesticide_recommendations.treatment_approach}</Text>

                        <Text style={[styles.subSubtitle, { color: isDarkMode ? '#ddd' : '#444' }]}>{labels.recommended_pesticides || t('recommendedPesticides')}:</Text>
                        {pesticide_recommendations.recommended_pesticides.map((pest: any, index: number) => (
                            <PesticideCard key={index} pesticide={pest} />
                        ))}
                    </View>

                    <View style={{ paddingHorizontal: 20 }}>
                        <CostCalculator
                            pesticides={pesticide_recommendations.recommended_pesticides}
                            preventionCostPerAcre={500}
                        />
                    </View>
                </>
            )}

            <View style={[styles.section, { backgroundColor: isDarkMode ? '#1e1e1e' : '#fff' }]}>
                <Text style={[styles.sectionTitle, { color: isDarkMode ? '#fff' : '#333' }]}>{labels.prevention_best_practices || t('preventionBestPractices')}</Text>
                <Text style={[styles.infoText, { color: isDarkMode ? '#ccc' : '#555' }]}>
                    {disease_info.prevention_steps || (prediction.disease === 'Healthy' ? t('preventionHealthy') : '')}
                </Text>

                {disease_info.organic_alternatives && (
                    <>
                        <Text style={[styles.subSubtitle, { color: isDarkMode ? '#ddd' : '#444' }]}>ðŸŒ¿ {labels.organic_alternatives || t('organicAlternatives')}:</Text>
                        <Text style={[styles.infoText, { color: isDarkMode ? '#ccc' : '#555' }]}>{disease_info.organic_alternatives}</Text>
                    </>
                )}
            </View>

            <TouchableOpacity style={[styles.doneButton, { backgroundColor: isDarkMode ? '#4caf50' : '#333' }]} onPress={() => router.replace('/(tabs)')}>
                <Check color="#fff" size={20} style={{ marginRight: 8 }} />
                <Text style={styles.doneButtonText}>{labels.finish_diagnosis || t('finishDiagnosis')}</Text>
            </TouchableOpacity>
        </ScrollView >
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: '#f5f5f5',
    },
    statusBanner: {
        flexDirection: 'row',
        alignItems: 'center',
        padding: 16,
        marginBottom: 12,
    },
    statusText: {
        fontSize: 16,
        fontWeight: 'bold',
        marginLeft: 12,
    },
    section: {
        backgroundColor: '#fff',
        padding: 20,
        marginBottom: 12,
    },
    titleRow: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 8,
    },
    cropTitle: {
        fontSize: 14,
        color: '#666',
        fontWeight: 'bold',
        letterSpacing: 1,
    },
    stageBadge: {
        backgroundColor: '#f0f0f0',
        paddingHorizontal: 10,
        paddingVertical: 4,
        borderRadius: 12,
    },
    stageText: {
        fontSize: 12,
        color: '#444',
    },
    diseaseName: {
        fontSize: 24,
        fontWeight: 'bold',
        color: '#333',
        marginBottom: 16,
    },
    statsRow: {
        flexDirection: 'row',
        marginTop: 16,
        gap: 16,
    },
    statBox: {
        flex: 1,
        backgroundColor: '#f9f9f9',
        padding: 12,
        borderRadius: 8,
        alignItems: 'center',
    },
    statLabel: {
        fontSize: 12,
        color: '#888',
        marginBottom: 4,
    },
    statValue: {
        fontSize: 18,
        fontWeight: 'bold',
        color: '#333',
    },
    actionButtons: {
        flexDirection: 'row',
        paddingHorizontal: 20,
        gap: 12,
        marginBottom: 20,
    },
    actionButton: {
        flex: 2,
        backgroundColor: '#4caf50',
        flexDirection: 'row',
        height: 48,
        borderRadius: 24,
        justifyContent: 'center',
        alignItems: 'center',
        elevation: 2,
    },
    secondaryButton: {
        flex: 1,
        backgroundColor: '#fff',
        borderWidth: 1,
        borderColor: '#4caf50',
    },
    actionButtonText: {
        color: '#fff',
        fontWeight: 'bold',
        marginLeft: 8,
    },
    secondaryButtonText: {
        color: '#4caf50',
    },
    weatherBox: {
        backgroundColor: '#e3f2fd',
        marginHorizontal: 20,
        padding: 16,
        borderRadius: 12,
        flexDirection: 'row',
        marginBottom: 20,
    },
    weatherContent: {
        marginLeft: 12,
        flex: 1,
    },
    weatherTitle: {
        fontSize: 16,
        fontWeight: 'bold',
        color: '#1976d2',
        marginBottom: 4,
    },
    weatherText: {
        fontSize: 14,
        color: '#444',
        lineHeight: 20,
    },
    sectionHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 16,
    },
    sectionTitle: {
        fontSize: 18,
        fontWeight: 'bold',
        color: '#333',
        marginBottom: 12,
    },
    urgencyBadge: {
        paddingHorizontal: 8,
        paddingVertical: 4,
        borderRadius: 6,
    },
    urgencyText: {
        fontSize: 10,
        fontWeight: '900',
    },
    approachText: {
        fontSize: 14,
        color: '#555',
        lineHeight: 22,
        marginBottom: 16,
        fontStyle: 'italic',
    },
    subSubtitle: {
        fontSize: 16,
        fontWeight: 'bold',
        color: '#444',
        marginTop: 12,
        marginBottom: 8,
    },
    infoText: {
        fontSize: 15,
        color: '#555',
        lineHeight: 24,
    },
    doneButton: {
        backgroundColor: '#333',
        margin: 20,
        height: 56,
        borderRadius: 12,
        flexDirection: 'row',
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 40,
    },
    doneButtonText: {
        color: '#fff',
        fontSize: 18,
        fontWeight: 'bold',
    },
});
